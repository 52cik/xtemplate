modulex.add("xtemplate/runtime",["./runtime/util","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(n,e,r){function o(n,e,r){var o=r[0],t=n&&n[o]||e&&e[o]||f[o];if(1===r.length)return t;if(t)for(var i=r.length,a=1;i>a&&(t=t[r[a]],t);a++);return t}function t(n,e){var r=n.split("/"),o=e.split("/");r.pop();for(var t=0,i=o.length;i>t;t++){var a=o[t];"."===a||(".."===a?r.pop():r.push(a))}return r.join("/")}function i(n,e,r){r=n.fn(e,r);var o=n.runtime.extendTplName;return o&&(delete n.runtime.extendTplName,r=n.root.include(o,n,e,null,r)),r.end()}function a(n,e,r,t,i,a,m,u){var c,f,l,s;if(a||(s=o(n.runtime.commands,n.root.config.commands,i)),s)return s.call(n,e,r,t,m);if(c="in file: "+n.name+" can not call: "+i.join(".")+'" at line '+m,u&&(f=e.resolve(i.slice(0,-1),a),l=f[i[i.length-1]]))return l.apply(f,r.params);if(c)throw new Error(c);return t}function m(n,e){var r=this;r.fn=n,e=r.config=e||{},e.loader=e.loader||m.loader,this.subNameResolveCache={}}var u=n("./runtime/util"),c=n("./runtime/commands"),f={},l=n("./runtime/scope"),s=n("./runtime/linked-buffer"),d={callFn:function(n,e,r,o,t,i,m){return a(n,e,r,o,t,i,m,!0)},callCommand:function(n,e,r,o,t,i){return a(n,e,r,o,t,0,i,!0)}},v={cache:{},load:function(e,r){var o=e.name,t=this.cache;return t[o]?r(void 0,t[o]):void n([o],{success:function(n){t[o]=n,r(void 0,n)},error:function(){var n='template "'+e.name+'" does not exist';u.log(n,"error"),r(n)}})}};u.mix(m,{loader:v,nativeCommands:c,utils:d,util:u,addCommand:function(n,e){f[n]=e},removeCommand:function(n){delete f[n]}}),m.prototype={constructor:m,Scope:l,nativeCommands:c,utils:d,removeCommand:function(n){var e=this.config;e.commands&&delete e.commands[n]},addCommand:function(n,e){var r=this.config;r.commands=r.commands||{},r.commands[n]=e},resolve:function(n,e){if("."!==n.charAt(0))return n;if(!e){var r="parent template does not have name for relative sub tpl name: "+n;throw new Error(r)}var o=this.subNameResolveCache[e]=this.subNameResolveCache[e]||{};return o[n]?o[n]:n=o[n]=t(e,n)},include:function(n,e,r,o,t){var a=this,m=e.name,u=a.resolve(n,m);return t.async(function(t){a.config.loader.load({root:a,parentName:m,originalName:n,name:u,scope:r,option:o},function(n,a){n?t.error(n):"string"==typeof a?t.write(a,o&&o.escape).end():i({root:e.root,fn:a,name:u,runtime:e.runtime},r,t)})})},render:function(n,e,r){var o="",t=this,a=t.fn;"function"==typeof e&&(r=e,e=null),e=e||{},r=r||function(n,e){if(n)throw n instanceof Error||(n=new Error(n)),n;o=e};var u=t.config.name;!u&&a.TPL_NAME&&(u=a.TPL_NAME);var c=new l(n),f=new m.LinkedBuffer(r,t.config).head;return i({name:u,fn:a,runtime:{commands:e.commands},root:t},c,f),o}},m.Scope=l,m.LinkedBuffer=s,r.exports=m});